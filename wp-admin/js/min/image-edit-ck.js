!function(i){var t=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,intval:function(i){return 0|i},setDisabled:function(t,e){e?(t.removeClass("disabled"),i("input",t).removeAttr("disabled")):(t.addClass("disabled"),i("input",t).prop("disabled",!0))},init:function(t){var e=this,a=i("#image-editor-"+e.postid),o=e.intval(i("#imgedit-x-"+t).val()),s=e.intval(i("#imgedit-y-"+t).val());e.postid!==t&&a.length&&e.close(e.postid),e.hold.w=e.hold.ow=o,e.hold.h=e.hold.oh=s,e.hold.xy_ratio=o/s,e.hold.sizer=parseFloat(i("#imgedit-sizer-"+t).val()),e.postid=t,i("#imgedit-response-"+t).empty(),i('input[type="text"]',"#imgedit-panel-"+t).keypress(function(t){var e=t.keyCode;return e>36&&41>e&&i(this).blur(),13===e?(t.preventDefault(),t.stopPropagation(),!1):void 0})},toggleEditor:function(t,e){var a=i("#imgedit-wait-"+t);e?a.height(i("#imgedit-panel-"+t).height()).fadeIn("fast"):a.fadeOut("fast")},toggleHelp:function(t){return i(t).parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},getTarget:function(t){return i('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,e){var a=i("#imgedit-scale-width-"+t),o=i("#imgedit-scale-height-"+t),s=i("#imgedit-scale-warn-"+t),d="",n="";e?(n=""!==a.val()?Math.round(a.val()/this.hold.xy_ratio):"",o.val(n)):(d=""!==o.val()?Math.round(o.val()*this.hold.xy_ratio):"",a.val(d)),n&&n>this.hold.oh||d&&d>this.hold.ow?s.css("visibility","visible"):s.css("visibility","hidden")},getSelRatio:function(t){var e=this.hold.w,a=this.hold.h,o=this.intval(i("#imgedit-crop-width-"+t).val()),s=this.intval(i("#imgedit-crop-height-"+t).val());return o&&s?o+":"+s:e&&a?e+":"+a:"1:1"},filterHistory:function(t,e){var a=i("#imgedit-history-"+t).val(),o,s,d,n,r=[];if(""!==a){if(a=JSON.parse(a),o=this.intval(i("#imgedit-undone-"+t).val()),o>0)for(;o>0;)a.pop(),o--;if(e){if(!a.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";d=a[a.length-1],d=d.c||d.r||d.f||!1,d&&(this.hold.w=d.fw,this.hold.h=d.fh)}for(s in a)n=a[s],n.hasOwnProperty("c")?r[s]={c:{x:n.c.x,y:n.c.y,w:n.c.w,h:n.c.h}}:n.hasOwnProperty("r")?r[s]={r:n.r.r}:n.hasOwnProperty("f")&&(r[s]={f:n.f.f});return JSON.stringify(r)}return""},refreshEditor:function(e,a,o){var s=this,d,n;s.toggleEditor(e,1),d={action:"imgedit-preview",_ajax_nonce:a,postid:e,history:s.filterHistory(e,1),rand:s.intval(1e6*Math.random())},n=i('<img id="image-preview-'+e+'" />').on("load",function(){var a,s,d=i("#imgedit-crop-"+e),r=t;d.empty().append(n),a=Math.max(r.hold.w,r.hold.h),s=Math.max(i(n).width(),i(n).height()),r.hold.sizer=a>s?s/a:1,r.initCrop(e,n,d),r.setCropSelection(e,0),"undefined"!=typeof o&&null!==o&&o(),i("#imgedit-history-"+e).val()&&"0"===i("#imgedit-undone-"+e).val()?i("input.imgedit-submit-btn","#imgedit-panel-"+e).removeAttr("disabled"):i("input.imgedit-submit-btn","#imgedit-panel-"+e).prop("disabled",!0),r.toggleEditor(e,0)}).on("error",function(){i("#imgedit-crop-"+e).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>"),s.toggleEditor(e,0)}).attr("src",ajaxurl+"?"+i.param(d))},action:function(t,e,a){var o=this,s,d,n,r,l;if(o.notsaved(t))return!1;if(s={action:"image-editor",_ajax_nonce:e,postid:t},"scale"===a){if(d=i("#imgedit-scale-width-"+t),n=i("#imgedit-scale-height-"+t),r=o.intval(d.val()),l=o.intval(n.val()),1>r)return d.focus(),!1;if(1>l)return n.focus(),!1;if(r===o.hold.ow||l===o.hold.oh)return!1;s["do"]="scale",s.fwidth=r,s.fheight=l}else{if("restore"!==a)return!1;s["do"]="restore"}o.toggleEditor(t,1),i.post(ajaxurl,s,function(e){i("#image-editor-"+t).empty().append(e),o.toggleEditor(t,0),o._view&&o._view.refresh()})},save:function(e,a){var o,s=this.getTarget(e),d=this.filterHistory(e,0),n=this;return""===d?!1:(this.toggleEditor(e,1),o={action:"image-editor",_ajax_nonce:a,postid:e,history:d,target:s,context:i("#image-edit-context").length?i("#image-edit-context").val():null,"do":"save"},void i.post(ajaxurl,o,function(a){var o=JSON.parse(a);return o.error?(i("#imgedit-response-"+e).html('<div class="error"><p>'+o.error+"</p><div>"),void t.close(e)):(o.fw&&o.fh&&i("#media-dims-"+e).html(o.fw+" &times; "+o.fh),o.thumbnail&&i(".thumbnail","#thumbnail-head-"+e).attr("src",""+o.thumbnail),o.msg&&i("#imgedit-response-"+e).html('<div class="updated"><p>'+o.msg+"</p></div>"),void(n._view?n._view.save():t.close(e)))}))},open:function(t,e,a){this._view=a;var o,s=i("#image-editor-"+t),d=i("#media-head-"+t),n=i("#imgedit-open-btn-"+t),r=n.siblings(".spinner");n.prop("disabled",!0),r.show(),o={action:"image-editor",_ajax_nonce:e,postid:t,"do":"open"},s.load(ajaxurl,o,function(){s.fadeIn("fast"),d.fadeOut("fast",function(){n.removeAttr("disabled"),r.hide()})})},imgLoaded:function(t){var e=i("#image-preview-"+t),a=i("#imgedit-crop-"+t);this.initCrop(t,e,a),this.setCropSelection(t,0),this.toggleEditor(t,0)},initCrop:function(e,a,o){var s=this,d=i("#imgedit-sel-width-"+e),n=i("#imgedit-sel-height-"+e),r;s.iasapi=i(a).imgAreaSelect({parent:o,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(t){r=i(t),r.next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),o.children().mousedown(function(i){var t=!1,a,o;i.shiftKey&&(a=s.iasapi.getSelection(),o=s.getSelRatio(e),t=a&&a.width&&a.height?a.width+":"+a.height:o),s.iasapi.setOptions({aspectRatio:t})})},onSelectStart:function(){t.setDisabled(i("#imgedit-crop-sel-"+e),1)},onSelectEnd:function(i,a){t.setCropSelection(e,a)},onSelectChange:function(i,e){var a=t.hold.sizer;d.val(t.round(e.width/a)),n.val(t.round(e.height/a))}})},setCropSelection:function(t,e){var a,o=i("#imgedit-minthumb-"+t).val()||"128:128",s=this.hold.sizer;return o=o.split(":"),e=e||0,!e||e.width<3&&e.height<3?(this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),0),this.setDisabled(i("#imgedit-crop-sel-"+t),0),i("#imgedit-sel-width-"+t).val(""),i("#imgedit-sel-height-"+t).val(""),i("#imgedit-selection-"+t).val(""),!1):e.width<o[0]*s&&e.height<o[1]*s?(this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),0),i("#imgedit-selection-"+t).val(""),!1):(a={x:e.x1,y:e.y1,w:e.width,h:e.height},this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),1),void i("#imgedit-selection-"+t).val(JSON.stringify(a)))},close:function(t,e){return e=e||!1,e&&this.notsaved(t)?!1:(this.iasapi={},this.hold={},void(this._view?this._view.back():i("#image-editor-"+t).fadeOut("fast",function(){i("#media-head-"+t).fadeIn("fast"),i(this).empty()})))},notsaved:function(t){var e=i("#imgedit-history-"+t).val(),a=""!==e?JSON.parse(e):[],o=this.intval(i("#imgedit-undone-"+t).val());return o<a.length?confirm(i("#imgedit-leaving-"+t).html())?!1:!0:!1},addStep:function(t,e,a){for(var o=this,s=i("#imgedit-history-"+e),d=""!==s.val()?JSON.parse(s.val()):[],n=i("#imgedit-undone-"+e),r=o.intval(n.val());r>0;)d.pop(),r--;n.val(0),d.push(t),s.val(JSON.stringify(d)),o.refreshEditor(e,a,function(){o.setDisabled(i("#image-undo-"+e),!0),o.setDisabled(i("#image-redo-"+e),!1)})},rotate:function(t,e,a,o){return i(o).hasClass("disabled")?!1:void this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},e,a)},flip:function(t,e,a,o){return i(o).hasClass("disabled")?!1:void this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},e,a)},crop:function(t,e,a){var o=i("#imgedit-selection-"+t).val(),s=this.intval(i("#imgedit-sel-width-"+t).val()),d=this.intval(i("#imgedit-sel-height-"+t).val());return i(a).hasClass("disabled")||""===o?!1:(o=JSON.parse(o),void(o.w>0&&o.h>0&&s>0&&d>0&&(o.fw=s,o.fh=d,this.addStep({c:o},t,e))))},undo:function(t,e){var a=this,o=i("#image-undo-"+t),s=i("#imgedit-undone-"+t),d=a.intval(s.val())+1;o.hasClass("disabled")||(s.val(d),a.refreshEditor(t,e,function(){var e=i("#imgedit-history-"+t),s=""!==e.val()?JSON.parse(e.val()):[];a.setDisabled(i("#image-redo-"+t),!0),a.setDisabled(o,d<s.length)}))},redo:function(t,e){var a=this,o=i("#image-redo-"+t),s=i("#imgedit-undone-"+t),d=a.intval(s.val())-1;o.hasClass("disabled")||(s.val(d),a.refreshEditor(t,e,function(){a.setDisabled(i("#image-undo-"+t),!0),a.setDisabled(o,d>0)}))},setNumSelection:function(t){var e,a=i("#imgedit-sel-width-"+t),o=i("#imgedit-sel-height-"+t),s=this.intval(a.val()),d=this.intval(o.val()),n=i("#image-preview-"+t),r=n.height(),l=n.width(),h=this.hold.sizer,g,v,p,c,m=this.iasapi;return 1>s?(a.val(""),!1):1>d?(o.val(""),!1):void(s&&d&&(e=m.getSelection())&&(p=e.x1+Math.round(s*h),c=e.y1+Math.round(d*h),g=e.x1,v=e.y1,p>l&&(g=0,p=l,a.val(Math.round(p/h))),c>r&&(v=0,c=r,o.val(Math.round(c/h))),m.setSelection(g,v,p,c),m.update(),this.setCropSelection(t,m.getSelection())))},round:function(i){var t;return i=Math.round(i),this.hold.sizer>.6?i:(t=i.toString().slice(-1),"1"===t?i-1:"9"===t?i+1:i)},setRatioSelection:function(t,e,a){var o,s,d=this.intval(i("#imgedit-crop-width-"+t).val()),n=this.intval(i("#imgedit-crop-height-"+t).val()),r=i("#image-preview-"+t).height();return this.intval(i(a).val())?void(d&&n&&(this.iasapi.setOptions({aspectRatio:d+":"+n}),(o=this.iasapi.getSelection(!0))&&(s=Math.ceil(o.y1+(o.x2-o.x1)/(d/n)),s>r&&(s=r,e?i("#imgedit-crop-height-"+t).val(""):i("#imgedit-crop-width-"+t).val("")),this.iasapi.setSelection(o.x1,o.y1,o.x2,s),this.iasapi.update()))):void i(a).val("")}}}(jQuery);